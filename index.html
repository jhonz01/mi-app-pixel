<script>
  const mensajes = [
    "Paâ€™ ti mi cachetona hermosa ðŸŒ¹",
    "Te extraÃ±o mucho ðŸ’–",
    "Eres mi persona favorita ðŸ˜˜",
    "Siempre pienso en ti ðŸ¥°",
    "Â¡SonrÃ­e, mi amor! ðŸ˜Š",
    "TÃº eres mi cielo ðŸŒˆ",
    "Â¡Te amo infinito! ðŸ’ž",
    "Eres mi pixel preferido ðŸŸª",
    "Quiero abrazarte ya ðŸ«‚",
    "Â¡Eres mi razÃ³n de sonreÃ­r! ðŸ˜"
  ];

  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");
  ctx.imageSmoothingEnabled = false;

  const sprites = {
    idle: new Image(),
    walk: new Image(),
    ellaIdle: new Image(),
    ellaWalk: new Image()
  };
  sprites.idle.src = "sprites/idle.png";
  sprites.walk.src = "sprites/walk.png";
  sprites.ellaIdle.src = "sprites/ella_idle.png";
  sprites.ellaWalk.src = "sprites/ella_walk.png";

  const sueloAltura = 32;
  const offsetSuelo = 4;

  // ðŸŸ¢ NUEVA VARIABLE DE ESCALA Y AJUSTE DE VELOCIDAD
  const escala = 2; // tamaÃ±o x2
  const velocidadBase = 1.5 / escala; // se mueve mÃ¡s despacio proporcionalmente

  // ðŸŸ¢ AJUSTE DE PERSONAJES
  let player = { 
    x: 0, 
    y: canvas.height - sueloAltura - (32 * escala) + offsetSuelo,
    width: 32 * escala, 
    height: 32 * escala,
    frame: 0, frameCount: 4, speed: velocidadBase,
    action: "idle", autoWalk: false 
  };

  let ella = { 
    x: canvas.width - (32 * escala), 
    y: canvas.height - sueloAltura - (32 * escala) + offsetSuelo,
    width: 32 * escala, 
    height: 32 * escala,
    frame: 0, frameCount: 4, speed: velocidadBase,
    action: "idle", autoWalk: false 
  };

  let corazones = [];

  function nuevoMensaje() {
    document.getElementById("mensaje").innerText = mensajes[Math.floor(Math.random()*mensajes.length)];
  }
  document.getElementById("btnMensaje").onclick = nuevoMensaje;
  document.getElementById("mensaje").onclick = nuevoMensaje;

  document.getElementById("btnAutoWalk").onclick = () => {
    player.x = 0;
    ella.x = canvas.width - ella.width;
    player.action = "walk";
    ella.action = "walk";
    player.autoWalk = true;
    ella.autoWalk = true;
    corazones = [];
  };

  const musica = document.getElementById("musica");
  document.getElementById("btnMusica").onclick = () => musica.paused ? musica.play() : musica.pause();
  const voz = document.getElementById("voz");
  document.getElementById("btnVoz").onclick = () => { voz.currentTime = 0; voz.play(); };

  // estrellas
  let estrellas = Array.from({length: 50}, () => ({x: Math.random()*canvas.width,y: Math.random()*(canvas.height - sueloAltura),brillo: Math.random()}));
  let fugaces = [];

  function generarFugaces() {
    let cantidad = Math.floor(Math.random()*4);
    for (let i=0; i<cantidad; i++) {
      fugaces.push({x: Math.random()*canvas.width,y: Math.random()*canvas.height/2,vx: -2 - Math.random()*2,vy: 1 + Math.random()*1,vida: 50 + Math.random()*50});
    }
  }
  setInterval(generarFugaces, 8000);

  // nubes lentas
  let clouds = Array.from({length: 5}, () => ({
    x: Math.random()*canvas.width,
    y: 20 + Math.random()*40,
    size: 10 + Math.random()*15,
    speed: 0.02 + Math.random()*0.02
  }));

  // fase lunar
  function getMoonPhaseFraction() {
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth() + 1;
    const day = now.getDate();
    const c = 29.530588853;
    const j = (year-2000)*12.3685 + month;
    const i = j|0;
    const k = i/1236.85;
    const t = k*k;
    const n = day + (year-2000)*365.25 + month*30.6;
    const phase = (n%c)/c;
    return phase;
  }

  const sueloImg = new Image();
  sueloImg.src = "sprites/suelo.png";

  function dibujarEscenario() {
    let hora = new Date().getHours();
    let colorCielo;
    if (hora >= 5 && hora < 8) colorCielo = '#FFB36B';
    else if (hora >= 8 && hora < 17) colorCielo = '#87CEEB';
    else if (hora >= 17 && hora < 19) colorCielo = '#FF7E5E';
    else colorCielo = '#0B0033';
    ctx.fillStyle = colorCielo;
    ctx.fillRect(0,0,canvas.width,canvas.height);

    if (hora >= 19 || hora < 5) {
      estrellas.forEach(e=>{
        e.brillo += (Math.random()-0.5)*0.1;
        e.brillo = Math.max(0.2, Math.min(1, e.brillo));
        ctx.fillStyle = `rgba(255,255,255,${e.brillo})`;
        ctx.fillRect(Math.floor(e.x), Math.floor(e.y), 1, 1);
      });
      fugaces.forEach(f=>{
        ctx.strokeStyle = 'white';
        ctx.beginPath();
        ctx.moveTo(f.x,f.y);
        ctx.lineTo(f.x+5,f.y-2);
        ctx.stroke();
        f.x += f.vx; f.y += f.vy; f.vida--;
      });
      fugaces = fugaces.filter(f=>f.vida>0);
    }

    if (hora>=6 && hora<19){
      let sunProgress = (hora-6)/13;
      let sunX = sunProgress*canvas.width;
      let sunY = 40 - Math.sin(sunProgress*Math.PI)*30;
      ctx.fillStyle = '#FFD700';
      ctx.fillRect(sunX, sunY, 16,16);
    }

    if (hora>=19 || hora<6){
      let moonProgress = (hora>=19? (hora-19)/11 : (hora+5)/11);
      let moonX = canvas.width - moonProgress*canvas.width;
      let moonY = 40 - Math.sin(moonProgress*Math.PI)*30;
      let phase = getMoonPhaseFraction();
      ctx.fillStyle = '#CCCCCC';
      ctx.fillRect(moonX, moonY, 16,16);
      ctx.fillStyle = colorCielo;
      ctx.fillRect(moonX+16*phase, moonY, 16*(1-phase),16);
    }

    clouds.forEach(cl=>{
      ctx.fillStyle = '#FFFFFF';
      ctx.fillRect(cl.x, cl.y, cl.size, cl.size/2);
      ctx.fillRect(cl.x+cl.size/4, cl.y-2, cl.size/2, cl.size/2);
      cl.x += cl.speed;
      if (cl.x>canvas.width) cl.x=-cl.size;
    });

    const tiles = Math.ceil(canvas.width / 320);
    for (let i = 0; i < tiles; i++) {
      ctx.drawImage(sueloImg, i * 320, canvas.height - 32, 320, 32);
    }
  }

  let frameTimer = 0;
  function update() {
    frameTimer++;
    if (frameTimer % 10 === 0){
      player.frame = (player.frame + 1) % player.frameCount;
      ella.frame = (ella.frame + 1) % ella.frameCount;
    }
    let centroX = (canvas.width - player.width)/2 - player.width/2;
    let centroElla = (canvas.width - ella.width)/2 + ella.width/2;
    if (player.autoWalk) {
      if (player.x < centroX) player.x += player.speed; else {player.x = centroX;player.action = "idle";}
    }
    if (ella.autoWalk) {
      if (ella.x > centroElla) ella.x -= ella.speed; else {ella.x = centroElla;ella.action = "idle";}
    }
    if (player.action==="idle" && ella.action==="idle" && corazones.length===0){
      for (let i=0; i<10; i++){
        corazones.push({x: (player.x+ella.x)/2+player.width/2,y: player.y,vy: -1-Math.random()*1,vida: 60+Math.random()*40});
      }
    }
    draw();
    requestAnimationFrame(update);
  }

  function draw() {
    dibujarEscenario();
    let sprite1 = sprites[player.action];
    ctx.drawImage(sprite1, player.frame * 32, 0, 32, 32, player.x, player.y, player.width, player.height);
    let sprite2 = sprites["ella"+capitalize(ella.action)];
    ctx.save();
    ctx.translate(ella.x + ella.width, ella.y);
    ctx.scale(-1,1);
    ctx.drawImage(sprite2, ella.frame * 32, 0, 32, 32, 0, 0, ella.width, ella.height);
    ctx.restore();
    corazones.forEach(c=>{
      ctx.fillStyle = 'pink';
      ctx.fillRect(c.x,c.y,2,2);
      ctx.fillRect(c.x-1,c.y+1,1,1);
      ctx.fillRect(c.x+2,c.y+1,1,1);
      c.y += c.vy;
      c.vida--;
    });
    corazones = corazones.filter(c=>c.vida>0);
  }

  function capitalize(str){ return str.charAt(0).toUpperCase()+str.slice(1); }
  update();
</script>
